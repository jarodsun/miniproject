### **系统设计：基于 Next.js + Electron + SQLite 的简易 CRM**

#### **1. 技术栈 (Updated)**

*   **全栈框架：** Next.js
    *   **前端路由：** App Router (用于构建用户界面和页面)
    *   **后端 API：** Pages Router (位于 `src/pages/api`，用于提供后端数据接口)
*   **数据库：** SQLite
*   **ORM (对象关系映射)：** Prisma (用于数据库管理和交互)
*   **UI 框架：** Material UI (MUI) (用于构建美观、响应式的用户界面)
*   **桌面应用打包：** Electron (将 Next.js 应用封装成可双击运行的桌面应用程序)

#### **2. 项目结构 (Project Structure - Updated)**

我们将采用一个集成的项目结构，将 Next.js 应用作为 Electron 的渲染进程内容。

```
crm-app/
├── .env                  # 环境变量
├── next.config.js        # Next.js 配置
├── package.json          # Node.js 项目配置，包含依赖 (Next.js, React, Electron, Prisma, MUI 等)
├── tsconfig.json         # TypeScript 配置
├── public/               # 静态资源 (favicon, 图片等)
│   └── ...
├── prisma/               # Prisma 配置文件和 Schema
│   └── schema.prisma     # Prisma 数据库模型定义
│   └── migrations/       # Prisma 数据库迁移文件
├── src/                  # 应用程序源代码
│   ├── app/              # Next.js App Router 模式下的前端页面和组件
│   │   ├── layout.tsx    # 根布局
│   │   ├── page.tsx      # 首页/仪表盘
│   │   ├── products/     # 货品管理页面
│   │   │   ├── page.tsx  # 货品列表
│   │   │   └── [id]/page.tsx # 货品详情/编辑
│   │   ├── merchants/    # 商家管理页面
│   │   │   ├── page.tsx  # 商家列表
│   │   │   └── [id]/page.tsx # 商家详情/编辑
│   │   ├── inventory/    # 出入库管理页面
│   │   │   └── page.tsx  # 出入库操作及记录
│   │   ├── analysis/     # 销售分析页面
│   │   │   └── page.tsx  # 商家年度采购趋势图表
│   │   └── api/          # App Router 的 Route Handlers (如果需要，但主要API在pages/api)
│   ├── pages/            # Next.js Pages Router 模式 (仅用于 API 路由)
│   │   └── api/          # Next.js API 路由 (后端逻辑)
│   │       ├── products.ts     # 货品 CRUD API
│   │       ├── merchants.ts    # 商家 CRUD API
│   │       ├── transactions.ts # 出入库记录 API
│   │       ├── analysis.ts     # 销售分析数据 API
│   │       └── upload-image.ts # 图片上传 API
│   ├── components/       # 可复用 React 组件 (MUI)
│   │   ├── ProductForm.tsx
│   │   ├── MerchantForm.tsx
│   │   ├── InventoryForm.tsx
│   │   ├── ChartComponent.tsx  # 用于分析图表
│   │   └── ...
│   ├── lib/              # 工具函数、Prisma 客户端初始化等
│   │   ├── prisma.ts     # Prisma 客户端初始化
│   │   ├── types.ts      # TypeScript 类型定义
│   │   └── constants.ts  # 应用常量
│   └── styles/           # 全局样式、MUI 主题配置
│       └── ...
├── electron/             # Electron 相关文件
│   ├── main.js           # Electron 主进程脚本 (创建窗口, 应用生命周期)
│   └── preload.js        # Electron 预加载脚本 (安全地暴露 Node.js API 给渲染进程)
└── data/                 # 存放 SQLite 数据库文件和上传的图片
    ├── crm.db            # SQLite 数据库文件
    └── images/           # 上传的图片文件
        └── ...
```

#### **3. 数据模型 (Prisma Schema & SQLite)**

我们将使用 Prisma 定义数据模型，Prisma 会自动生成 SQLite 数据库的表结构。

*   **`prisma/schema.prisma` 定义:**

```prisma
// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL") // 通常指向 "file:./data/crm.db"
}

model Product {
  id          Int           @id @default(autoincrement())
  name        String        @unique
  sku         String?       @unique
  description String?
  currentStock Int          @default(0)
  imageUrl    String?       // 存储图片链接或本地路径
  unit        String?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  transactions Transaction[]
}

model Merchant {
  id           Int           @id @default(autoincrement())
  name         String        @unique
  contactPerson String?
  phoneNumber  String?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  transactions Transaction[]
}

model Transaction {
  id             Int       @id @default(autoincrement())
  productId      Int
  type           String    // 'IN' or 'OUT'
  quantity       Int
  transactionDate DateTime  @default(now())
  merchantId     Int?      // Nullable for 'IN' transactions
  createdAt      DateTime  @default(now())

  product        Product   @relation(fields: [productId], references: [id])
  merchant       Merchant? @relation(fields: [merchantId], references: [id])

  @@index([productId])
  @@index([merchantId])
}
```

#### **4. 核心组件与流程 (Updated)**

*   **Prisma 客户端初始化 (`lib/prisma.ts`)**
    *   初始化 PrismaClient 实例，用于所有数据库操作。
    *   确保 PrismaClient 是单例模式，避免重复连接。

*   **Next.js API 路由 (`src/pages/api/*.ts` - Pages Router)**
    *   这些 API 路由将作为后端接口，处理前端发来的数据请求，并使用 Prisma 与 SQLite 数据库交互。
    *   **`products.ts`:** 提供货品的增删改查 (CRUD) 接口。
        *   `GET /api/products`: 获取所有货品列表。
        *   `POST /api/products`: 添加新货品，同时更新 `currentStock`。
        *   `GET /api/products/[id]`: 获取单个货品详情。
        *   `PUT /api/products/[id]`: 更新货品信息。
        *   `DELETE /api/products/[id]`: 删除货品。
    *   **`merchants.ts`:** 提供商家的增删改查 (CRUD) 接口。
        *   `GET /api/merchants`: 获取所有商家列表。
        *   `POST /api/merchants`: 添加新商家。
        *   `GET /api/merchants/[id]`: 获取单个商家详情。
        *   `PUT /api/merchants/[id]`: 更新商家信息。
        *   `DELETE /api/merchants/[id]`: 删除商家。
    *   **`transactions.ts`:** 处理出入库操作。
        *   `POST /api/transactions/in`: 记录入库交易，增加对应货品的 `currentStock`。
        *   `POST /api/transactions/out`: 记录出库交易，减少对应货品的 `currentStock`，并关联 `merchantId`。
        *   `POST /api/transactions/out`: 记录出库交易，减少对应货品的 `currentStock`，并关联 `merchantId`。
        *   `GET /api/transactions`: 获取所有交易记录，支持按日期、货品、商家、类型等筛选。
    *   **`analysis.ts`:** 提供分析数据。
        *   `GET /api/analysis/merchant/[id]`: 获取指定商家近一年的每月采购数据。
    *   **`upload-image.ts` (图片上传 API)**
        *   `POST /api/upload-image`: 接收前端上传的图片文件。
        *   将图片保存到本地文件系统 (`data/images/` 目录)。
        *   返回保存后的图片路径或文件名，供前端更新 `Product` 的 `imageUrl` 字段。

*   **前端页面 (`src/app/*.tsx` - App Router)**
    *   所有页面和组件都将使用 Material UI (MUI) 组件库进行构建，确保界面美观和一致性。
    *   每个页面将通过 `fetch` 或 `axios` 等库调用对应的 API 路由来获取和提交数据。
    *   **货品/商家管理页面：** 包含列表展示、添加/编辑表单、删除确认等功能。货品编辑表单将包含图片上传组件，调用 `upload-image.ts` API。
    *   **出入库管理页面：** 提供选择货品、输入数量、选择商家（出库时）和日期的表单。
    *   **销售分析页面：**
        *   提供商家选择器。
        *   使用图表库（如 `Chart.js` 或 `Recharts`，并结合 MUI 样式）来渲染柱状图或折线图，展示选定商家近一年的每月采购量。
        *   图表应能清晰地标示出采购高峰月份。

#### **5. Electron 集成策略 (No Change)**

*   **`electron/main.js` (主进程)**
    *   负责创建 Electron 窗口。
    *   在开发模式下，加载 `http://localhost:3000` (Next.js 开发服务器地址)。
    *   在生产模式下，加载打包后的 Next.js 应用的 `index.html` 文件。
    *   处理应用生命周期事件（如关闭窗口、退出应用）。
    *   **关键：** 在应用启动时，确保 Next.js 应用已构建并准备好服务。
*   **`electron/preload.js` (预加载脚本)**
    *   在渲染进程（网页）加载之前运行，提供一个安全的桥梁，允许渲染进程访问 Node.js API，但仅限于明确暴露的接口，以增强安全性。
    *   对于本系统，大部分数据交互通过 Next.js API 路由完成，所以 `preload.js` 可能只需要暴露一些基本的 Electron IPC (Inter-Process Communication) 接口，或者用于调试目的。
*   **打包工具：** 使用 `electron-builder` 或 `electron-packager`。
    *   这些工具将负责：
        *   执行 `next build` 命令，构建 Next.js 应用。
        *   将构建好的 Next.js 输出、Electron 脚本和所有依赖项打包成一个独立的桌面应用程序（`.exe`, `.app` 等）。
        *   确保 SQLite 数据库文件 (`data/crm.db`) 和 `data/images` 目录被正确包含在打包后的应用中。

#### **下一步计划：**

我将开始搭建项目的基础结构，包括：
1.  初始化一个 Next.js 项目 (使用 TypeScript)。
2.  安装必要的依赖（`electron`, `electron-builder`, `prisma`, `@prisma/client`, `@mui/material`, `@emotion/react`, `@emotion/styled` 等）。
3.  配置 Prisma (创建 `schema.prisma` 文件，并运行 `prisma migrate dev` 进行数据库初始化)。
4.  设置基本的 Electron 主进程和预加载脚本。
5.  创建 `lib/prisma.ts` 文件，用于初始化 Prisma 客户端。
6.  创建 `data/images` 目录。